"use strict";(self.webpackChunkavalonia_docs=self.webpackChunkavalonia_docs||[]).push([[3077],{47777:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>u,frontMatter:()=>s,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"tutorials/music-store-app/displaying-images","title":"Displaying Images","description":"TUTORIALS - Music Store App","source":"@site/docs/tutorials/music-store-app/displaying-images.md","sourceDirName":"tutorials/music-store-app","slug":"/tutorials/music-store-app/displaying-images","permalink":"/zh-Hans/docs/tutorials/music-store-app/displaying-images","draft":false,"unlisted":false,"editUrl":"https://github.com/AvaloniaUI/avalonia-docs/tree/main/docs/tutorials/music-store-app/displaying-images.md","tags":[],"version":"current","lastUpdatedBy":"202420505","lastUpdatedAt":1755588461000,"frontMatter":{"description":"TUTORIALS - Music Store App"},"sidebar":"documentationSidebar","previous":{"title":"Album Service","permalink":"/zh-Hans/docs/tutorials/music-store-app/searching-for-albums"},"next":{"title":"Dialog Return","permalink":"/zh-Hans/docs/tutorials/music-store-app/return-from-dialog"}}');var t=a(74848),l=a(28453);const o=a.p+"assets/images/image-20210310173858088-01c46b8609b7d0f2b7ce9f682a2ac9f0.png",s={description:"TUTORIALS - Music Store App"},r="Displaying Images",c={},d=[{value:"Album Service",id:"album-service",level:2},{value:"Album View Model",id:"album-view-model",level:2},{value:"Load Cover Art",id:"load-cover-art",level:2},{value:"Cancellable Image Load",id:"cancellable-image-load",level:2},{value:"Album View",id:"album-view",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"displaying-images",children:"Displaying Images"})}),"\n",(0,t.jsx)(n.p,{children:"On this page, you will learn how to retrieve the cover art bitmap for each album in the search results. You will then be able to display the image on each album tile view instead of the placeholder note icon."}),"\n",(0,t.jsx)(n.h2,{id:"album-service",children:"Album Service"}),"\n",(0,t.jsxs)(n.p,{children:["Your first step is to modify the business service to retrieve the album cover art from the ",(0,t.jsx)(n.em,{children:"Apple iTunes"})," Web API."]}),"\n",(0,t.jsx)(n.p,{children:"Follow this procedure to get the album cover art from the Web API:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Stop the app if it is still running."}),"\n",(0,t.jsxs)(n.li,{children:["Locate and open the ",(0,t.jsx)(n.strong,{children:"Album.cs"})," file in the ",(0,t.jsx)(n.strong,{children:"/Models"})," folder."]}),"\n",(0,t.jsx)(n.li,{children:"Add the code as shown:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:'private static HttpClient s_httpClient = new();\nprivate string CachePath => $"./Cache/{SanitizeFileName(Artist)} - {SanitizeFileName(Title)}";\n\npublic async Task<Stream> LoadCoverBitmapAsync()\n{\n    if (File.Exists(CachePath + ".bmp"))\n    {\n        return File.OpenRead(CachePath + ".bmp");\n    }\n    else\n    {\n        var data = await s_httpClient.GetByteArrayAsync(CoverUrl);\n        return new MemoryStream(data);\n    }\n}\n\nprivate static string SanitizeFileName(string input)\n{\n    foreach (var c in Path.GetInvalidFileNameChars())\n    {\n        input = input.Replace(c, \'_\');\n    }\n    return input;\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Method ",(0,t.jsx)(n.code,{children:"LoadCoverBitmapAsync()"})," returns a stream that can be used to load a bitmap from, either from a cache file or from the API.\nMethod  ",(0,t.jsx)(n.code,{children:"SanitizeFileName()"})," sanitizes input to replace characters that cannot be used in the file name with ",(0,t.jsx)(n.code,{children:"_"}),"."]}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsx)(n.p,{children:"Note that the cache is not active at this time, you will implement it later in the tutorial."})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"So that you will see as soon as the cache becomes active, place a debug breakpoint at the following line:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:'return File.OpenRead(CachePath + ".bmp");\n'})}),"\n",(0,t.jsx)(n.h2,{id:"album-view-model",children:"Album View Model"}),"\n",(0,t.jsx)(n.p,{children:"In this step , you will add a property to the album view model to store the cover art as a bitmap."}),"\n",(0,t.jsx)(n.admonition,{type:"warning",children:(0,t.jsxs)(n.p,{children:["Note: You must reference ",(0,t.jsx)(n.code,{children:"Avalonia.Media.Imaging"})," in the album view model because you must use the ",(0,t.jsx)(n.em,{children:"Avalonia UI"})," bitmap here, and ",(0,t.jsx)(n.strong,{children:"not"})," the .NET ",(0,t.jsx)(n.code,{children:"System.Bitmap"}),"."]})}),"\n",(0,t.jsx)(n.p,{children:"Follow this procedure to update the album view model:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Locate and open the ",(0,t.jsx)(n.strong,{children:"AlbumViewModel.cs"})," file."]}),"\n",(0,t.jsxs)(n.li,{children:["Add the ",(0,t.jsx)(n.code,{children:"using Avalonia.Media.Imaging;"})," reference."]}),"\n",(0,t.jsx)(n.li,{children:"Add the extra code for the album cover, as shown:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:"using Avalonia.Media.Imaging;\nusing System.Threading.Tasks;\nusing CommunityToolkit.Mvvm.ComponentModel;\n...\n\npublic partial class AlbumViewModel : ViewModelBase\n{\n    ...\n    \n    [ObservableProperty] public partial Bitmap? Cover { get; private set; }\n    \n    public async Task LoadCover()\n    {\n        await using (var imageStream = await _album.LoadCoverBitmapAsync())\n        {\n            Cover = await Task.Run(() => Bitmap.DecodeToWidth(imageStream, 400));\n        }\n    }\n}   \n"})}),"\n",(0,t.jsxs)(n.p,{children:["Take some time to examine this code because it gives an insight into manipulating images with ",(0,t.jsx)(n.em,{children:"Avalonia UI."})," For example, the above uses the ",(0,t.jsx)(n.code,{children:"DecodeToWidth"})," method to convert the image stream for display in ",(0,t.jsx)(n.em,{children:"Avalonia UI"}),". This method can convert a stream for a large high resolution image into a smaller bitmap, at a specified width and while maintaining the aspect ratio."]}),"\n",(0,t.jsx)(n.p,{children:"This means that you will not waste large amounts of memory to display the album cover art, even though the Web API returns quite large files."}),"\n",(0,t.jsxs)(n.p,{children:["Also notice how the ",(0,t.jsx)(n.code,{children:"LoadCover"})," method is coded to run asynchronously, and on a background thread. This is so that the UI thread does not get blocked and make the UI unresponsive."]}),"\n",(0,t.jsx)(n.h2,{id:"load-cover-art",children:"Load Cover Art"}),"\n",(0,t.jsx)(n.p,{children:"In this step you will alter the album search (in the music store view model) so that the cover art is loaded for each album that is found. To maintain the responsiveness of the app, you will make this process both asynchronous and cancellable."}),"\n",(0,t.jsx)(n.p,{children:"Firstly, you will need to add a method that can start loading the album covers whenever search results are returned. You will make this method asynchronous and cancellable."}),"\n",(0,t.jsx)(n.p,{children:"To add the method to load album cover art, follow this procedure:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Locate and open the ",(0,t.jsx)(n.strong,{children:"MusicStoreViewModel.cs"})," file."]}),"\n",(0,t.jsx)(n.li,{children:"Add the code as shown:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:"private async void LoadCovers(CancellationToken cancellationToken)\n{\n    foreach (var album in SearchResults.ToList())\n    {\n        await album.LoadCover();\n        if (cancellationToken.IsCancellationRequested)\n        {\n            return;\n        }\n    }\n}\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"warning",children:(0,t.jsxs)(n.p,{children:["Important note: this method iterates through a ",(0,t.jsx)(n.strong,{children:"copy"})," of the search results collection  (created by the ",(0,t.jsx)(n.code,{children:"ToList"})," method). This is because it runs asynchronously on its own thread, and the original  results collection could get changed at any time by another thread."]})}),"\n",(0,t.jsx)(n.p,{children:"The cancellation token argument will allow you to stop the method loading album covers whenever needed."}),"\n",(0,t.jsx)(n.h2,{id:"cancellable-image-load",children:"Cancellable Image Load"}),"\n",(0,t.jsxs)(n.p,{children:["In this step you will call the ",(0,t.jsx)(n.code,{children:"LoadCovers"})," method in the ",(0,t.jsx)(n.code,{children:"DoSearch"})," method (in the music store view model) but with full cancellation management."]}),"\n",(0,t.jsx)(n.p,{children:"Follow this procedure:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Add this field to the ",(0,t.jsx)(n.strong,{children:"MusicStoreViewModel.cs"})," file."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:"private CancellationTokenSource? _cancellationTokenSource;\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Modify the code at the beginning of the ",(0,t.jsx)(n.code,{children:"DoSearch"})," method to set up the cancellation token:"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:"_cancellationTokenSource?.Cancel();\n_cancellationTokenSource = new CancellationTokenSource();\nvar cancellationToken = _cancellationTokenSource.Token;\n"})}),"\n",(0,t.jsxs)(n.p,{children:["So if there is an existing request still loading album art, this will cancel it. Again, because ",(0,t.jsx)(n.code,{children:"_cancellationTokenSource"})," might be replaced asynchronously by another thread, you have to work with a copy stored as a local variable."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Add the following code to the end of ",(0,t.jsx)(n.code,{children:"DoSearch"})," method:"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:"if (!cancellationToken.IsCancellationRequested)\n{\n    LoadCovers(cancellationToken);\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["At this stage, your ",(0,t.jsx)(n.code,{children:"DoSearch"})," method should look like this:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:"private async Task DoSearch(string? term)\n{\n    _cancellationTokenSource?.Cancel();\n    _cancellationTokenSource = new CancellationTokenSource();\n    var cancellationToken = _cancellationTokenSource.Token;\n\n    IsBusy = true;\n    SearchResults.Clear();\n\n    var albums = await Album.SearchAsync(term);\n\n    foreach (var album in albums)\n    {\n        var vm = new AlbumViewModel(album);\n        SearchResults.Add(vm);\n    }\n\n    if (!cancellationToken.IsCancellationRequested)\n    {\n        LoadCovers(cancellationToken);\n    }\n\n    IsBusy = false;\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"album-view",children:"Album View"}),"\n",(0,t.jsx)(n.p,{children:"In the last step here, you will alter the data bindings in the album view so that the tile can display the album cover image. You will also add a test so that the placeholder panel is visible only when the album cover image is not available (is null)."}),"\n",(0,t.jsx)(n.p,{children:"Follow this procedure:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Locate and open the ",(0,t.jsx)(n.strong,{children:"AlbumView.axaml"})," file."]}),"\n",(0,t.jsxs)(n.li,{children:["Add the data binding ",(0,t.jsx)(n.code,{children:'Source="{Binding Cover}"'})," to the ",(0,t.jsx)(n.code,{children:"<Image>"})," element as shown below:"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'<Image Width="200" Stretch="Uniform" Source="{Binding Cover}" />\n'})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Add data binding and converter to the panel element below as shown:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'<Panel Height="200" IsVisible="{Binding Cover, Converter={x:Static ObjectConverters.IsNull}}">\n'})}),"\n",(0,t.jsxs)(n.p,{children:["A converter is an extension of a data binding expression that can convert the binding value before it is passed to the bound control. The ",(0,t.jsx)(n.code,{children:"IsNull"})," converter returns a Boolean that is true when the value object is null."]}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsxs)(n.p,{children:["For more information about the ",(0,t.jsx)(n.em,{children:"Avalonia UI"})," built-in binding converters, see the reference ",(0,t.jsx)(n.a,{href:"/zh-Hans/docs/reference/built-in-data-binding-converters",children:"here"}),"."]})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.strong,{children:"Debug"})," to compile and run the project."]}),"\n",(0,t.jsx)(n.li,{children:"Click the icon button."}),"\n",(0,t.jsx)(n.li,{children:"Type some search text."}),"\n"]}),"\n",(0,t.jsx)("p",{children:(0,t.jsx)("img",{className:"image-medium-zoom",src:o,alt:""})}),"\n",(0,t.jsx)(n.p,{children:"Notice how the album covers load one by one, and the UI remains responsive."}),"\n",(0,t.jsxs)(n.p,{children:["On the next page, you will learn how to return the selected album from dialog, when the user clicks  ",(0,t.jsx)(n.strong,{children:"Buy Album"})," button."]})]})}function u(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},28453:(e,n,a)=>{a.d(n,{R:()=>o,x:()=>s});var i=a(96540);const t={},l=i.createContext(t);function o(e){const n=i.useContext(l);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),i.createElement(l.Provider,{value:n},e.children)}}}]);