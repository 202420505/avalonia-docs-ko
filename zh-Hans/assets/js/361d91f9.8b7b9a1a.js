"use strict";(self.webpackChunkavalonia_docs=self.webpackChunkavalonia_docs||[]).push([[6598],{71720:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>p,frontMatter:()=>o,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"advanced/headless-testing","title":"Headless Testing","description":"Overview","source":"@site/xpf/advanced/headless-testing.md","sourceDirName":"advanced","slug":"/advanced/headless-testing","permalink":"/zh-Hans/xpf/advanced/headless-testing","draft":false,"unlisted":false,"editUrl":"https://github.com/AvaloniaUI/avalonia-docs/tree/main/xpf/advanced/headless-testing.md","tags":[],"version":"current","frontMatter":{"id":"headless-testing","title":"Headless Testing"},"sidebar":"documentationSidebar","previous":{"title":"Customizing Window decorations","permalink":"/zh-Hans/xpf/advanced/customizing-window-decorations"},"next":{"title":"Key Mapping","permalink":"/zh-Hans/xpf/advanced/key-mapping"}}');var s=t(74848),a=t(28453);const o={id:"headless-testing",title:"Headless Testing"},l=void 0,r={},d=[{value:"Overview",id:"overview",level:2},{value:"Configuring testing project",id:"configuring-testing-project",level:2},{value:"(Optional) Configuring testing application",id:"optional-configuring-testing-application",level:2},{value:"Writing tests",id:"writing-tests",level:2},{value:"Accessing Avalonia headless extensions",id:"accessing-avalonia-headless-extensions",level:2},{value:"(Optional) Using XPF headless testing with WPF app/project",id:"optional-using-xpf-headless-testing-with-wpf-appproject",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"Unit-testing was always a complicated scenario with WPF. The most common solution was to run heavy automation based e2e testing suits. Making it slower and locking it to Windows only testing."}),"\n",(0,s.jsx)(n.p,{children:"In Avalonia, instead of automation testing, we always recommend trying Headless testing first as it's fast and portable.\nSince XPF is based on the same core as Avalonia, we made headless testing possible on WPF apps too."}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsxs)(n.p,{children:["We have prepared a complete ",(0,s.jsx)(n.a,{href:"https://github.com/AvaloniaUIOU/CalculatorDemo/tree/headless-testing",children:"CalculatorDemo sample"})," with headless tests. Please ask our support team to give you access to this repository, if you need."]})}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["If you need more detailed documentation on Headless platform and Avalonia extensions, please visit ",(0,s.jsx)(n.a,{href:"https://docs.avaloniaui.net/docs/concepts/headless/",children:"Avalonia documentation"})," and ",(0,s.jsx)(n.a,{href:"https://github.com/AvaloniaUI/Avalonia.Samples/tree/main/src/Avalonia.Samples/Testing/TestableApp.Headless.XUnit",children:"Avalonia samples"}),". Understanding how it works with Avalonia also helps with XPF/WPF."]})}),"\n",(0,s.jsx)(n.h2,{id:"configuring-testing-project",children:"Configuring testing project"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"XUnit"})," and ",(0,s.jsx)(n.code,{children:"NUnit"})," are currently supported by XPF/Avalonia headless testing.\nIt's necessary to include integration nuget package in the testing project:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-xml",children:'<ItemGroup>\n    <PackageReference Include="Avalonia.Headless.XUnit" Version="$(XpfAvaloniaVersion)" />\n    or\n    <PackageReference Include="Avalonia.Headless.NUnit" Version="$(XpfAvaloniaVersion)" />\n</ItemGroup>\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"$(XpfAvaloniaVersion)"})," is pre-defined const in the ",(0,s.jsx)(n.code,{children:"Xpf.Sdk"}),", which also needs to be set in testing project. It can be skipped, if you specify latest ",(0,s.jsx)(n.code,{children:"PackageReference"})," version manually."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"AvaloniaUI.Xpf.LicenseKey"})," is also required for testing project to pass runtime validation. See ",(0,s.jsx)(n.a,{href:"/zh-Hans/xpf/getting-started",children:"Getting started"})," page if you need more information where to get this key."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-xml",children:'<ItemGroup>\n    <RuntimeHostConfigurationOption Include="AvaloniaUI.Xpf.LicenseKey" Value="--Insert your key here--"/>\n</ItemGroup>\n'})}),"\n",(0,s.jsx)(n.h2,{id:"optional-configuring-testing-application",children:"(Optional) Configuring testing application"}),"\n",(0,s.jsxs)(n.p,{children:["Similarly to Avalonia headless, you can configure cross-platform ",(0,s.jsx)(n.code,{children:"AppBuilder"})," to be used in the project.\nWhen not defined, headless platform is using default parameters, which might limit your XPF testing experience.\nNote, if you already override AppBuilder for your XPF app (as per ",(0,s.jsx)(n.a,{href:"/zh-Hans/xpf/advanced/customizing-init",children:"Customizing Initialization"})," documentation), you can reuse the same initialization code, but add ",(0,s.jsx)(n.code,{children:".UseHeadless()"})," in the end of the chain."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:"[assembly: AvaloniaTestApplication(typeof(TestAppBuilder))]\n\npublic class TestAppBuilder\n{\n    // See https://docs.avaloniaui.net/docs/concepts/headless/headless-nunit#initialize-nunit-tests\n    // XPF specific: we need to add .WithAvaloniaXpf and keep DefaultXpfAvaloniaApplication was already preconfigured default themes.\n    public static AppBuilder BuildAvaloniaApp() => AppBuilder.Configure<DefaultXpfAvaloniaApplication>()\n        .WithAvaloniaXpf()\n        .UseSkia()\n        .UseHeadless(new AvaloniaHeadlessPlatformOptions\n        {\n            // Required for capturing rendered frame https://docs.avaloniaui.net/docs/concepts/headless/#capturing-the-last-rendered-frame\n            UseHeadlessDrawing = false\n        });\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"writing-tests",children:"Writing tests"}),"\n",(0,s.jsxs)(n.p,{children:["Your tests are running in the same process as the XPF application, making it easier to send any events and access any output of the app.\nAs with normal WPF app, everything has to start with a Window, which can be create in the same test method, or reused from set-up methods (",(0,s.jsx)(n.code,{children:"[SetUp]"})," method in NUnit or constructor in XUnit)."]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"NUnit [Test] and [Theory] needs to be replaced with [AvaloniaTest] [AvaloniaTheory],\nas well as XUnit [Fact] replaced with [AvaloniaFact]."})}),"\n",(0,s.jsx)(n.p,{children:"Very basic NUnit test would look like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:'[AvaloniaTest]\npublic void Should_Be_Able_To_Raise_Event()\n{\n    var window = new MainWindow();\n    window.Show();\n    var button = window.ClickingButton;\n\n    Assert.That(button.Content, Is.EqualTo("Click me"));\n\n    button.RaiseEvent(new RoutedEventArgs(ButtonBase.ClickEvent, button));\n\n    Assert.That(button.Content, Is.EqualTo("Click count: 1"));\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Where Button logic is straightforward:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:'private int _clickCount = 0;\nprivate void ClickingButton_OnClick(object sender, RoutedEventArgs e)\n{\n    ClickingButton.Content = "Click count: " + (++_clickCount).ToString();\n}\n'})}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsxs)(n.p,{children:["To access ",(0,s.jsx)(n.code,{children:"ClickingButton"})," from the testing project, you either need to set ",(0,s.jsxs)(n.a,{href:"https://learn.microsoft.com/en-us/dotnet/desktop/xaml-services/xfieldmodifier-directive",children:["x",":FieldModifier",'="public"']})," on the control, or define ",(0,s.jsx)(n.code,{children:"InternalsVisibleTo"})," attribute."]})}),"\n",(0,s.jsx)(n.h2,{id:"accessing-avalonia-headless-extensions",children:"Accessing Avalonia headless extensions"}),"\n",(0,s.jsxs)(n.p,{children:["In ",(0,s.jsx)(n.a,{href:"https://docs.avaloniaui.net/docs/concepts/headless/",children:"Avalonia documentation"})," you might find some useful headless extensions for simulating clicks and keyboard input, avoiding raising fake WPF events."]}),"\n",(0,s.jsx)(n.p,{children:"This extensions are only available on Avalonia Window, and can't be used on WPF Window.\nBut lucky, it's possible to get Avalonia Window in headless tests:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:'// Get Avalonia window and send text input to currently focused control.\nvar avWindow = XpfWpfAbstraction.GetAvaloniaWindowForWindow(xpfWindow);\navWindow.KeyTextInput("Hello");\n'})}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"/zh-Hans/xpf/advanced/avalonia-interop",children:"Avalonia Interop"})," for more details on integration with Avalonia."]}),"\n",(0,s.jsx)(n.h2,{id:"optional-using-xpf-headless-testing-with-wpf-appproject",children:"(Optional) Using XPF headless testing with WPF app/project"}),"\n",(0,s.jsx)(n.p,{children:'Only startup project has to use Xpf.Sdk testing.\nWhich also means that you can have normal "net8.0-windows" project with your controls, and reference them in XPF headless project.'}),"\n",(0,s.jsx)(n.p,{children:"It can be useful, if you have shared controls library that and want to headless test it, or maybe if you have normal Windows WPF application and need headless testing without fully using XPF."}),"\n",(0,s.jsxs)(n.p,{children:["All the usage steps are the same, but you also need to set testing project TargetFramework to ",(0,s.jsx)(n.code,{children:"net8.0-windows"})," and set ",(0,s.jsx)(n.code,{children:"EnableWindowsTargeting"})," to true (only if you need to run it on Linux/macOS machines)."]})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>l});var i=t(96540);const s={},a=i.createContext(s);function o(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);